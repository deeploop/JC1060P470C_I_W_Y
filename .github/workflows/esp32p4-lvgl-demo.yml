name: ESP32-P4 LVGL Demo v9 Build

on:
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'ESP-IDF/lvgl_demo_v9/**'
      - '.github/workflows/esp32p4-lvgl-demo.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'ESP-IDF/lvgl_demo_v9/**'
      - '.github/workflows/esp32p4-lvgl-demo.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build ESP32-P4 LVGL Demo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ESP-IDF dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip python3-venv \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

      - name: Cache ESP-IDF
        id: cache-esp-idf
        uses: actions/cache@v4
        with:
          path: |
            ~/esp/esp-idf
            ~/.espressif
          key: esp-idf-v5.3-esp32p4-${{ runner.os }}

      - name: Clone and setup ESP-IDF
        if: steps.cache-esp-idf.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/esp
          cd ~/esp
          git clone --recursive --branch v5.3 --depth 1 https://github.com/espressif/esp-idf.git
          cd esp-idf
          ./install.sh esp32p4

      - name: Export ESP-IDF environment
        run: |
          . ~/esp/esp-idf/export.sh
          echo "ESP-IDF environment exported"
          echo "IDF_PATH: $IDF_PATH"
          echo "Python version: $(python --version)"
          echo "Verifying ESP-IDF component manager version..."
          pip show idf-component-manager || echo "Component manager will be installed on first build"

      - name: Fix ESP-IDF Python dependencies
        run: |
          . ~/esp/esp-idf/export.sh
          echo "Re-running ESP-IDF install.sh to ensure correct Python package versions..."
          cd ~/esp/esp-idf
          ./install.sh esp32p4
          echo "Component manager version after install:"
          pip show idf-component-manager | grep Version || true

      - name: Verify project structure
        working-directory: ESP-IDF/lvgl_demo_v9
        run: |
          echo "Checking project structure..."
          ls -la
          echo "Checking components directory..."
          ls -la components/
          echo "Checking main directory..."
          ls -la main/

      - name: Cache managed components
        uses: actions/cache@v4
        with:
          path: |
            ESP-IDF/lvgl_demo_v9/managed_components
            ESP-IDF/lvgl_demo_v9/.component_cache
          key: managed-components-${{ hashFiles('ESP-IDF/lvgl_demo_v9/main/idf_component.yml', 'ESP-IDF/lvgl_demo_v9/components/**/idf_component.yml') }}
          restore-keys: |
            managed-components-

      - name: Clean old build artifacts
        working-directory: ESP-IDF/lvgl_demo_v9
        run: |
          echo "Cleaning old build artifacts..."
          rm -f dependencies.lock
          rm -rf build/
          echo "Clean complete"

      - name: Set target and download dependencies
        working-directory: ESP-IDF/lvgl_demo_v9
        run: |
          . ~/esp/esp-idf/export.sh
          echo "ðŸ“¦ Setting target to ESP32-P4..."
          idf.py set-target esp32p4
          echo ""
          echo "ðŸ“¥ Downloading managed components from ESP Component Registry..."
          idf.py reconfigure
          echo ""
          echo "âœ… Dependency resolution complete!"
          echo ""
          if [ -f "dependencies.lock" ]; then
            echo "ðŸ“„ dependencies.lock generated successfully"
          fi
          if [ -d "managed_components" ]; then
            echo "ðŸ“¦ Managed components downloaded:"
            ls -1 managed_components/ | sed 's/^/  âœ“ /'
          else
            echo "âš ï¸ Warning: managed_components directory not found"
            exit 1
          fi

      - name: Cache build output
        uses: actions/cache@v4
        with:
          path: |
            ESP-IDF/lvgl_demo_v9/build
            ~/.ccache
          key: build-esp32p4-lvgl-v9-${{ github.sha }}
          restore-keys: |
            build-esp32p4-lvgl-v9-

      - name: Build project
        working-directory: ESP-IDF/lvgl_demo_v9
        timeout-minutes: 30
        run: |
          . ~/esp/esp-idf/export.sh
          echo "ðŸ”¨ Starting build for ESP32-P4..."
          echo "IDF_PATH: $IDF_PATH"
          echo "Component Manager: $(pip show idf-component-manager | grep Version)"
          idf.py build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32p4-lvgl-demo-firmware
          path: |
            ESP-IDF/lvgl_demo_v9/build/bootloader/bootloader.bin
            ESP-IDF/lvgl_demo_v9/build/partition_table/partition-table.bin
            ESP-IDF/lvgl_demo_v9/build/lvgl_demo_v9.bin
            ESP-IDF/lvgl_demo_v9/build/lvgl_demo_v9.elf
            ESP-IDF/lvgl_demo_v9/build/lvgl_demo_v9.map
            ESP-IDF/lvgl_demo_v9/build/flash_args
          retention-days: 30

      - name: Generate build summary
        if: success()
        working-directory: ESP-IDF/lvgl_demo_v9
        run: |
          . ~/esp/esp-idf/export.sh
          echo "## âœ… Build Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** ESP32-P4" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** LVGL Demo v9" >> $GITHUB_STEP_SUMMARY
          echo "- **ESP-IDF Version:** v5.3" >> $GITHUB_STEP_SUMMARY
          echo "- **LVGL Version:** 9.2.x" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binary Sizes" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          idf.py size 2>&1 || echo "Size information not available"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Component Versions" >> $GITHUB_STEP_SUMMARY
          if [ -d "managed_components" ]; then
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -1 managed_components/ | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Flash Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "idf.py -p PORT flash monitor" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts have been uploaded and can be downloaded from the workflow run." >> $GITHUB_STEP_SUMMARY

      - name: Build failure diagnostics
        if: failure()
        working-directory: ESP-IDF/lvgl_demo_v9
        run: |
          . ~/esp/esp-idf/export.sh
          echo "## âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Diagnostics" >> $GITHUB_STEP_SUMMARY
          echo "Please check the build log above for detailed error messages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Information" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "IDF_PATH: $IDF_PATH" >> $GITHUB_STEP_SUMMARY
          echo "Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          pip show idf-component-manager | grep Version >> $GITHUB_STEP_SUMMARY || echo "idf-component-manager: not found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build/CMakeCache.txt ]; then
            echo "### CMake Configuration" >> $GITHUB_STEP_SUMMARY
            echo "âœ… CMake cache file exists. Build got past configuration stage." >> $GITHUB_STEP_SUMMARY
          else
            echo "### CMake Configuration" >> $GITHUB_STEP_SUMMARY
            echo "âŒ CMake cache file not found. Build failed during configuration." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check build warnings
        working-directory: ESP-IDF/lvgl_demo_v9
        run: |
          if [ -f build/warnings.txt ]; then
            echo "## Build Warnings" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat build/warnings.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
