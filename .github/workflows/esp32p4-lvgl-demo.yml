name: ESP32‑P4 LVGL Demo Build (Rev1.99)

on:
  push:
    branches:
      - main
      - master
      - 'claude/**'
    paths:
      - 'ESP-IDF/lvgl_demo_v9/**'
      - '.github/workflows/esp32p4-lvgl-demo.yml'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'ESP-IDF/lvgl_demo_v9/**'
      - '.github/workflows/esp32p4-lvgl-demo.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build ESP32‑P4 Firmware
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git wget flex bison gperf cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0

    - name: Cache ESP‑IDF tools
      id: cache-idf
      uses: actions/cache@v4
      with:
        path: |
          ~/esp/esp-idf
          ~/.espressif
        key: esp-idf-v5.3-${{ runner.os }}

    - name: Clone and install ESP‑IDF v5.3
      if: steps.cache-idf.outputs.cache-hit != 'true'
      run: |
        mkdir -p ~/esp
        cd ~/esp
        git clone --recursive --branch v5.3 --depth 1 https://github.com/espressif/esp-idf.git
        cd esp-idf
        ./install.sh esp32p4

    - name: Export ESP‑IDF environment
      run: |
        . ~/esp/esp-idf/export.sh
        echo "IDF_PATH=$IDF_PATH"
        python --version

    - name: Clean old build outputs
      working-directory: ESP-IDF/lvgl_demo_v9
      run: |
        rm -rf build sdkconfig sdkconfig.old dependencies.lock

    - name: Set target and fetch components
      working-directory: ESP-IDF/lvgl_demo_v9
      run: |
        . ~/esp/esp-idf/export.sh
        idf.py set-target esp32p4
        idf.py reconfigure

    - name: Fix sdkconfig chip revision (v1.99 support)
      working-directory: ESP-IDF/lvgl_demo_v9
      run: |
        . ~/esp/esp-idf/export.sh
        sed -i '/CONFIG_ESP32P4_REV_MAX_FULL/d' sdkconfig || true
        sed -i '/CONFIG_ESP_REV_MAX_FULL/d' sdkconfig || true
        echo "" >> sdkconfig
        echo "# Chip revision" >> sdkconfig
        echo "CONFIG_ESP32P4_REV_MAX_FULL=199" >> sdkconfig
        echo "CONFIG_ESP_REV_MAX_FULL=199" >> sdkconfig
        echo "✅ Patched sdkconfig:"
        grep CONFIG_ESP32P4_REV_MAX_FULL sdkconfig
        grep CONFIG_ESP_REV_MAX_FULL sdkconfig

    - name: Build project
      working-directory: ESP-IDF/lvgl_demo_v9
      run: |
        . ~/esp/esp-idf/export.sh
        idf.py build

    - name: Upload all build artifacts (keep original filenames)
      uses: actions/upload-artifact@v4
      with:
        name: esp32p4-lvgl-demo-firmware
        path: |
          ESP-IDF/lvgl_demo_v9/build/bootloader/bootloader.bin
          ESP-IDF/lvgl_demo_v9/build/partition_table/partition-table.bin
          ESP-IDF/lvgl_demo_v9/build/lvgl_demo_v9.bin
          ESP-IDF/lvgl_demo_v9/build/lvgl_demo_v9.elf
          ESP-IDF/lvgl_demo_v9/build/lvgl_demo_v9.map
          ESP-IDF/lvgl_demo_v9/build/flash_args
          ESP-IDF/lvgl_demo_v9/build/*.zip
